# 3장
#### SQL의 조건 분기
>구문에서 식으로
UNION은 조건분기에 적합하지 않다.

### 8강 - UNION을 사용한 쓸데없이 긴 표현

UNION은 외부적으로 하나의 SQL 구문을 실행하는 것으로 보이지만, 내부적으로 여러 개의 SELECT 구문을 실행하는 실행계획으로 해석되기 때문에, 테이블에 접근하는 횟수가 많아져 I/O비용이 크게 늘어난다.

#### 1. UNION을 사용한 조건 분기와 관련된 간단한 예제
~~쉬운내용이라 생략~~

#### 2. WHERE 구에서 조건 분기를 하는 사람은 초보자
~~쉬운내용이라 생략~~

#### 3. SELECT 구를 사용한 조건 분기의 실행 계획
`구문`에서 `식`으로 사고를 변경하는 것이 SQL을 마스터하는 열쇠 중 하나다.
문제를 절차 지향형 언어로 해결한다면 어떤 IF 조건문을 사용해야할까 라고 사고할 때마다, 이것을 SQL의 CASE로는 어떻게 해결할 수 있지? 라고 꾸준히 의식한다면 이것만으로도 큰 도움이 될 것이다.

### 9강 - 집계와 조건 분기

#### 1. 집계 대상으로 조건 분기
~~예시 생략~~

UNION으로 쿼리를 날린다면 Population 테이블에 풀스캔이 N회 수행된다.
~~예시 생략~~

하지만 CASE를 사용한다면 Population 테이블로의 풀 스캔이 1회로 감소한 것을 확인 할 수 있다.

#### 2. 집약 결과로 조건 분기
- CASE 식을 사용한 조건 분기의 실행 계획
  - COUNT 또는 SUM과 같은 집약 함수의 결과는 1개의 레코드로 압축된다. 집약 함수의 결과가 스칼라(더 이상 분할 불가능한 값)가 되는 것이다.
  - WHERE 구에서 조건 분기를 하는 사람은 초보자, HAVING 구에서 조건 분기를 하는 사람도 초보자.
  - SELECT 구문에서 조건분기를 하자!

### 10강 - 그래도 UNION이 필요한 경우
#### 1.UNION을 사용할 수밖에 없는 경우
- SELECT 구문들에서 사용하는 테이블이 다른 경우
- FROM구에서 JOIN을 하면 CASE 식으로 컨트롤 가능하지만 불필요한 결합이 발생하여 성능적으로 악영향이 발생 가능하다. (상황에 따라 실행 계획 등을 확인하여 더 좋은 플랜 선택하는게 좋다.)

#### 2. UNION을 사용하는 것이 성능적으로 더 좋은 경우
- UNION을 사용
이 책에서 요상한 예제를 보여줬다.
|key|name|date_1|flg_1|date_2|flg_2|date_3|flg_3|
|---|---|---|---|---|---|---|---|
|1|a|2013-11-01|T|||||
|2|b|||2013-11-01|T|||
|3|c|||||2013-11-01|T|
위 테이블을 추출하려면 UNION을 사용하는게 좋고, 이 쿼리를 최적의 성능으로 수행하려면 인덱스가 필요하다.
```sql
CREATE INDEX IDX_1 ON ThreeElements (date_1, flg_1);
CREATE INDEX IDX_2 ON ThreeElements (date_2, flg_2);
...
```
위와 같이 인덱스를 만들어주면 실행계획에서 Table Full Scan 이 아닌 Index Range Scan 방식을 선택하여 더 높은 성늘을 이끌어낸다.

- OR을 사용
  - OR을 사용하면 Index Range Scan 방식을 실행하지 않고 Table Full Scan을 실행한다.

Table이 크고, WHERE 조건으로 선택되는 레코드의 수가 충분히 작다면 UNION이 TABLE FULL SCAN보다 더 빠르다.

### 11강 - 절차 지향형과 선언형
#### 1. 구문 기반과 식 기반
- SQL 초보자는 절차 지향적인 세계에 살고있다.
  - 절차지향적 세계에서 생각의 기본 단위는 `구문(statement)`이다.
- SQL 중급자 이상은 선언적인 세계에서 살고 있다.
  - 여기서의 기본 단위는 `식(expression)`이다.
- 기본적인 생각의 체계(Scheme)가 다르다!

#### 2. 선언형의 세계로 도약
- 절차 지향형 세계에서 선언형 세계로 도약하는 것이 곧 SQL 능력 향상의 핵심이다.

---

### 마치며
- **SQL의 성능**은 저장소의 I/O를 얼마나 감소시킬 수 있을지가 열쇠
- UNION에서 조건분기를 표현한다면 "내가 지금 쓸데없이 길게 쓰고 있는 것은 아닐까?"라는 의심을 할 것
- IN 또는 CASE 식으로 조건 분기를 표현할 수 있다면, 테이블에의 스캔을 크게 감소시킬 가능성이 있음
- 이를 위해서라도, **구문에서 식으로의 패러다임 전환을 연습 할 것!**


